name: Daily Update Automation

on:
  schedule:
    # æ¯å¤©æ—©ä¸Š8ç‚¹è‡ªåŠ¨æ›´æ–° (UTCæ—¶é—´00:00 = åŒ—äº¬æ—¶é—´8:00)
    - cron: '0 0 * * *'
  workflow_dispatch:
  # æ‰‹åŠ¨è§¦å‘

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Update timestamp and docs
        run: |
          python -c "
          import datetime
          from pathlib import Path
          
          # æ›´æ–°READMEä¸­çš„æ—¶é—´æˆ³
          readme_path = Path('README.md')
          if readme_path.exists():
              content = readme_path.read_text(encoding='utf-8')
              now = datetime.datetime.now().strftime('%Y-%m-%d %H:%M:%S')
              
              # æ›´æ–°Last Commitå¾½ç« 
              old_badge = '![Last Commit]'
              new_badge = f'![Last Commit](https://img.shields.io/github/last-commit/zhangjc138/quant_project?style=flat-square) **Last updated: {now}**'
              
              if old_badge in content:
                  content = content.replace(
                      '![Last Commit](https://img.shields.io/github/last-commit/zhangjc138/quant_project?style=flat-square)',
                      f'![Last Commit](https://img.shields.io/github/last-commit/zhangjc138/quant_project?style=flat-square) **Updated: {now}**'
                  )
                  readme_path.write_text(content, encoding='utf-8')
                  print(f'âœ… Updated README timestamp: {now}')
              else:
                  print('âš ï¸ Last Commit badge not found')
          "
          
      - name: Add small improvements
        run: |
          # æ£€æŸ¥æ˜¯å¦æœ‰typoéœ€è¦ä¿®å¤
          echo "ğŸ”§ Performing minor improvements..."
          
          # æ›´æ–°requirements.txtä¸­çš„ç‰ˆæœ¬æ³¨é‡Šï¼ˆå¦‚æœéœ€è¦ï¼‰
          requirements = Path('requirements.txt')
          if requirements.exists():
              content = requirements.read_text(encoding='utf-8')
              if '# Updated:' not in content:
                  from datetime import datetime
                  content = f"# Updated: {datetime.now().strftime('%Y-%m-%d')}\n" + content
                  requirements.write_text(content, encoding='utf-8')
                  print("âœ… Updated requirements.txt")

      - name: Commit changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
          if git diff --quiet:
            echo "ğŸ“ No changes to commit, adding a minor update..."
            
            # æ·»åŠ ä¸€ä¸ªå°æ›´æ–°åˆ°READMEæœ«å°¾
            from datetime import datetime
            now = datetime.now().strftime('%Y-%m-%d %H:%M')
            
            readme_path = Path('README.md')
            if readme_path.exists():
                content = readme_path.read_text(encoding='utf-8')
                update_note = f"\n---\n### ğŸ“… è‡ªåŠ¨æ›´æ–° ({now})\n- é¡¹ç›®ä¿æŒæ´»è·ƒæ›´æ–°\n"
                content += update_note
                readme_path.write_text(content, encoding='utf-8')
                print("âœ… Added update note to README")
                
                git add README.md
                git commit -m "ğŸ¤– Auto-update: $(date +'%Y-%m-%d %H:%M') - Minor improvements" || echo "Nothing to commit"
          else
            git add -A
            git commit -m "ğŸ¤– Auto-update: $(date +'%Y-%m-%d %H:%M') - Daily improvements" || echo "Nothing to commit"
          fi

      - name: Push changes
        uses: ad-m/github-push-action@v0.8.0
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: main
        continue-on-error: true

      - name: Run trending check
        run: |
          echo "ğŸ“Š Running trending check..."
          python -c "
          import requests
          import json
          from datetime import datetime
          
          # è·å–é¡¹ç›®ä¿¡æ¯
          repo = 'zhangjc138/quant_project'
          api_url = f'https://api.github.com/repos/{repo}'
          
          try:
              response = requests.get(api_url, timeout=10)
              data = response.json()
              
              stars = data.get('stargazers_count', 0)
              forks = data.get('forks_count', 0)
              watchers = data.get('watchers_count', 0)
              
              print(f\"ğŸ“ˆ Stars: {stars}\")
              print(f\"ğŸ´ Forks: {forks}\")
              print(f\"ğŸ‘ï¸ Watchers: {watchers}\")
              
              # æ£€æŸ¥æ˜¯å¦åœ¨Trending
              trending_url = f'https://api.github.com/search/repositories?q={repo}&sort=stars'
              trending_resp = requests.get(trending_url, timeout=10)
              
              if trending_resp.status_code == 200:
                  items = trending_resp.json().get('items', [])
                  for i, item in enumerate(items, 1):
                      if item.get('full_name') == repo:
                          print(f\"ğŸ‰ é¡¹ç›®åœ¨GitHub Trendingæ’åç¬¬ {i} ä½ï¼\")
                          break
                  else:
                      print(\"ğŸ“Š æš‚æœªè¿›å…¥å…¨ç«™Trendingï¼ŒæŒç»­åŠªåŠ›ä¸­...\")
              
          except Exception as e:
              print(f\"âš ï¸ Error: {e}\")
          "
